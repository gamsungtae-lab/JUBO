<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆíŠ¸ ì£¼ë³´ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #F2F4F6; 
            color: #191F28;
            -webkit-tap-highlight-color: transparent;
        }
        
        .toss-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
        }
        
        .toss-input {
            background-color: #F9FAFB;
            border: 1px solid transparent;
            border-radius: 16px;
            transition: all 0.2s ease;
            color: #333D4B;
            appearance: none; 
            -webkit-appearance: none;
            cursor: pointer;
        }
        .toss-input:focus {
            background-color: white;
            border-color: #3182F6;
            box-shadow: 0 0 0 2px rgba(49, 130, 246, 0.1);
            outline: none;
        }
        
        .toss-btn {
            background-color: #3182F6;
            color: white;
            border-radius: 16px;
            font-weight: 600;
        }
        .toss-btn:active { background-color: #1B64DA; transform: scale(0.98); }

        .select-wrapper { position: relative; }
        .select-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #8B95A1;
        }

        .modal-bg { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="min-h-screen pb-10">

<div class="max-w-xl mx-auto relative">
    
    <header class="sticky top-0 z-10 bg-[#F2F4F6]/90 backdrop-blur-md px-6 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-[#191F28]">ì£¼ë³´ ì‘ì„±</h1>
        <button onclick="openModal()" class="bg-white text-[#3182F6] px-4 py-2 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 border border-transparent active:scale-95 transition-transform flex items-center gap-2">
            <i class="fas fa-list"></i> ì ‘ìˆ˜ í˜„í™©
        </button>
    </header>

    <main class="px-5 space-y-6 mt-2 relative z-0">
        <form id="juboForm" class="space-y-6">
            
            <div class="toss-card p-6 space-y-6">
                <div>
                    <label class="block text-sm font-bold text-[#8B95A1] mb-2 pl-1">ë‚ ì§œ</label>
                    <div class="select-wrapper">
                        <input type="date" id="targetDate" class="toss-input w-full p-4 text-lg font-bold" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-[#8B95A1] mb-2 pl-1">ë¶€ì„œ</label>
                    <div class="select-wrapper">
                        <select id="department" class="toss-input w-full p-4 text-lg font-bold pr-10" onchange="updateFormFields()" required>
                            <option value="">ì–´ë”” ë¶€ì„œì¸ê°€ìš”?</option>
                            
                            <optgroup label="ğŸµ ì°¬ì–‘ ë° ì˜ˆë°°">
                                <option value="worship_1">1ë¶€ ê²½ë°°ì™€ì°¬ì–‘</option>
                                <option value="worship_23">2-3ë¶€ ê²½ë°°ì™€ì°¬ì–‘</option>
                                <option value="choir_all">ì°¬ì–‘ëŒ€ (ì „ì²´)</option>
                            </optgroup>

                            <optgroup label="ğŸ“– ì„¤êµ">
                                <option value="sermon_4">4ë¶€ ì˜ˆë°° ì„¤êµ</option>
                                <option value="sermon_5">5ë¶€ ì˜ˆë°° ì„¤êµ</option>
                                <option value="sermon_pm">ì˜¤í›„ì˜ˆë°° ì„¤êµ</option>
                                <option value="sermon_wed_am">ìˆ˜ìš”ì˜¤ì „ ì„¤êµ</option>
                                <option value="sermon_wed_pm">ìˆ˜ìš”ì €ë… ì„¤êµ</option>
                            </optgroup>

                            <optgroup label="ğŸŒ± ë‹¤ìŒì„¸ëŒ€">
                                <option value="youth">ì²­ë…„ë¶€</option>
                                <option value="school">êµíšŒí•™êµ</option>
                            </optgroup>

                            <optgroup label="ğŸ“¢ ê¸°íƒ€ / êµìš°ì†Œì‹">
                                <option value="news">ê´‘ê³  / ì¼ë°˜ì†Œì‹</option>
                                <option value="fellowship">êµìš°ì†Œì‹ (ì¥ë¡€/ê²°í˜¼/ì¶œì‚°)</option>
                                <option value="service">ë´‰ì‚¬ / ê¸°íƒ€</option>
                            </optgroup>
                        </select>
                        <div class="select-icon"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-[#8B95A1] mb-2 pl-1">ì‘ì„±ì</label>
                    <input type="text" id="writer" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜ ì „ë„ì‚¬" class="toss-input w-full p-4 font-medium" required>
                </div>
            </div>

            <div id="dynamicFields" class="hidden toss-card p-6 space-y-4">
                </div>

            <button type="submit" id="submitBtn" class="toss-btn w-full py-4 text-lg shadow-lg shadow-blue-500/20">
                ë³´ë‚´ê¸°
            </button>
        </form>
    </main>

    <div id="viewModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center">
        <div id="modalBackdrop" class="absolute inset-0 bg-black/40 opacity-0 modal-bg" onclick="closeModal()"></div>
        <div id="modalContent" class="relative bg-[#F2F4F6] w-full max-w-lg h-[90vh] sm:h-[80vh] rounded-t-[28px] sm:rounded-[28px] shadow-2xl flex flex-col overflow-hidden transform translate-y-full modal-content">
            
            <div class="bg-white p-5 border-b border-gray-100 rounded-t-[28px] z-20">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-[#191F28] pl-1">ì ‘ìˆ˜ í˜„í™©</h2>
                    <button onclick="closeModal()" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200">
                    <span class="text-xs font-bold text-gray-500 pl-2">ì¡°íšŒ ë‚ ì§œ:</span>
                    <input type="date" id="modalDateInput" class="bg-transparent font-bold text-[#3182F6] flex-1 outline-none" onchange="fetchData()">
                </div>
            </div>
            
            <div id="viewContent" class="flex-1 overflow-y-auto p-5 space-y-4">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 gap-3">
                    <i class="fas fa-spinner fa-spin text-2xl text-[#3182F6]"></i>
                    <p class="font-medium">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // ğŸ”´ [í•„ìˆ˜] êµ¬ê¸€ ìŠ¤í¬ë¦½íŠ¸ URLì„ ê¼­ ë„£ì–´ì£¼ì„¸ìš”!
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxAItLf7sBsBhX-VIcTWruv1ukt8XSR-qNMy_GesNUhPQQFvDkCoztFQqDVNSrXrYuu/exec'; 

    // ë‚ ì§œ ìë™ ì„¤ì •
    const today = new Date(); 
    const nextSun = new Date(today.setDate(today.getDate() + (7 - today.getDay()) % 7 || 7));
    const nextSunString = nextSun.toISOString().split('T')[0];
    
    document.getElementById('targetDate').value = nextSunString;

    // 1. ì…ë ¥ì°½ ë¡œì§
    function updateFormFields() {
        const dept = document.getElementById('department').value;
        const div = document.getElementById('dynamicFields');
        div.innerHTML = ''; 
        
        if (!dept) { div.classList.add('hidden'); return; }
        div.classList.remove('hidden');

        let html = '';

        // Case A: êµìš°ì†Œì‹
        if (dept === 'fellowship') {
            html = `
                <div>
                    <h3 class="text-lg font-bold text-[#3182F6] mb-2">êµìš°ì†Œì‹ ì…ë ¥</h3>
                    <div class="select-wrapper mb-3">
                        <select id="field1" class="toss-input w-full p-4 font-bold">
                            <option value="ì¥ë¡€">âš« ì¥ë¡€ (ì†Œì²œ)</option>
                            <option value="ê²°í˜¼">ğŸ’ ê²°í˜¼</option>
                            <option value="ì¶œì‚°">ğŸ‘¶ ì¶œì‚°</option>
                            <option value="ì…ì›">ğŸ¥ ì…ì›/ê¸°íƒ€</option>
                        </select>
                        <div class="select-icon"><i class="fas fa-chevron-down"></i></div>
                    </div>
                    <textarea id="longText" rows="5" class="toss-input w-full p-4 resize-none" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.&#13;&#10;(ì˜ˆ: 000 ì„±ë„ ë¶€ì¹œìƒ, ì¥ë¡€ì‹ì¥ ë“±)"></textarea>
                </div>`;
        }
        // Case B: ì²­ë…„ë¶€/êµíšŒí•™êµ
        else if (dept === 'school' || dept === 'youth') {
            const label = dept === 'youth' ? 'ì²­ë…„ë¶€' : 'êµíšŒí•™êµ';
            html = `
                <div>
                    <h3 class="text-lg font-bold text-[#3182F6] mb-1">${label} ì†Œì‹</h3>
                    <p class="text-xs text-gray-400 mb-3">ë‚´ìš©ë§Œ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”</p>
                    <textarea id="longText" rows="6" class="toss-input w-full p-4 resize-none" placeholder="ê´‘ê³  ë‚´ìš©, ëª¨ì„ ì¥ì†Œ ë“±ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>`;
        }
        // Case C: ì„¤êµ
        else if (dept.includes('sermon')) {
            html = `
                <h3 class="text-lg font-bold text-[#191F28] mb-3">ì„¤êµ ì •ë³´</h3>
                <input id="field1" class="toss-input w-full p-4 mb-3" placeholder="ì„±ê²½ ë³¸ë¬¸ (ì˜ˆ: ìš” 3:16)">
                <input id="field2" class="toss-input w-full p-4" placeholder="ì„¤êµ ì œëª©">`;
        }
        // Case D: ì°¬ì–‘
        else if (dept.includes('worship') || dept === 'choir_all') {
            let ph = "ê³¡ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            if (dept === 'choir_all') ph = "ì˜ˆì‹œ:\n1ë¶€: ê³¡ëª…\n2ë¶€: ê³¡ëª…\n3ë¶€: ê³¡ëª…";
            html = `
                <h3 class="text-lg font-bold text-[#191F28] mb-3">ì°¬ì–‘ ì½˜í‹°</h3>
                <textarea id="longText" rows="6" class="toss-input w-full p-4 resize-none" placeholder="${ph}"></textarea>`;
        }
        // Case E: ì¼ë°˜ ê´‘ê³ /ë´‰ì‚¬
        else {
            let sub = dept === 'news' 
                ? `<div class="select-wrapper mb-3"><select id="field1" class="toss-input w-full p-4"><option>êµíšŒì†Œì‹</option><option>ê¸°ê´€ì†Œì‹</option><option>ëª¨ì§‘</option></select><div class="select-icon"><i class="fas fa-chevron-down"></i></div></div>` 
                : `<input id="field1" class="toss-input w-full p-4 mb-3" placeholder="ë´‰ì‚¬/ë¶€ì„œëª…">`;
            html = `${sub}<textarea id="longText" rows="5" class="toss-input w-full p-4 resize-none" placeholder="ë‚´ìš© ì…ë ¥"></textarea>`;
        }
        div.innerHTML = html;
    }

    // 2. ì œì¶œ ë¡œì§
    document.getElementById('juboForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = 'ì „ì†¡ ì¤‘...'; btn.disabled = true;

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                targetDate: document.getElementById('targetDate').value,
                department: document.getElementById('department').value,
                writer: document.getElementById('writer').value,
                field1: document.getElementById('field1')?.value || '',
                field2: document.getElementById('field2')?.value || '',
                longText: document.getElementById('longText')?.value || ''
            }),
            mode: 'no-cors'
        }).then(() => {
            alert('âœ… ì œì¶œ ì™„ë£Œ!'); window.location.reload();
        });
    });

    // 3. ëª¨ë‹¬ ë¡œì§
    let allDataCache = []; // ë°ì´í„°ë¥¼ í•œë²ˆ ê°€ì ¸ì˜¤ë©´ ì €ì¥í•´ë‘ëŠ” ë³€ìˆ˜

    function openModal() {
        const modal = document.getElementById('viewModal');
        const backdrop = document.getElementById('modalBackdrop');
        const content = document.getElementById('modalContent');
        const modalDateInput = document.getElementById('modalDateInput');
        
        // ë©”ì¸ í™”ë©´ì˜ ë‚ ì§œë¥¼ ëª¨ë‹¬ ë‚ ì§œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const mainDate = document.getElementById('targetDate').value;
        modalDateInput.value = mainDate;

        modal.classList.remove('hidden');
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            content.classList.remove('translate-y-full');
        }, 10);
        
        fetchData(); // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    }

    function closeModal() {
        const modal = document.getElementById('viewModal');
        const backdrop = document.getElementById('modalBackdrop');
        const content = document.getElementById('modalContent');
        
        backdrop.classList.add('opacity-0');
        content.classList.add('translate-y-full');
        setTimeout(() => { modal.classList.add('hidden'); }, 300);
    }

    // 4. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° & í•„í„°ë§ (ì—…ê·¸ë ˆì´ë“œ ë¨!)
    function fetchData() {
        const container = document.getElementById('viewContent');
        // â­ ëª¨ë‹¬ ì•ˆì— ìˆëŠ” ë‚ ì§œ ì…ë ¥ì¹¸ì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤!
        const filterDate = document.getElementById('modalDateInput').value; 
        
        container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 gap-3"><i class="fas fa-spinner fa-spin text-2xl text-[#3182F6]"></i><p>ë°ì´í„° í™•ì¸ ì¤‘...</p></div>`;

        // ë°ì´í„°ë¥¼ ì´ë¯¸ ê°€ì ¸ì™”ë‹¤ë©´ ë‹¤ì‹œ ìš”ì²­í•˜ì§€ ì•Šê³  í•„í„°ë§ë§Œ í•¨ (ì†ë„ í–¥ìƒ)
        if (allDataCache.length > 0) {
            renderList(allDataCache, filterDate);
            return;
        }

        fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            allDataCache = data; // ê°€ì ¸ì˜¨ ë°ì´í„° ì €ì¥
            renderList(data, filterDate);
        });
    }

    // ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ë¶„ë¦¬ë¨)
    function renderList(data, date) {
        const container = document.getElementById('viewContent');
        // ë‚ ì§œ í•„í„°ë§
        const filtered = data.filter(i => i.date.startsWith(date));
        
        container.innerHTML = '';
        
        if (!filtered.length) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 gap-3"><i class="far fa-folder-open text-4xl mb-2"></i><p>${date}<br>ì ‘ìˆ˜ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            return;
        }

        filtered.forEach(item => {
            let copyText = "";
            let badgeColor = "bg-gray-100 text-gray-500";
            let deptLabel = item.department;

            // êµìš°ì†Œì‹ì¸ ê²½ìš° ë±ƒì§€ ìƒ‰ìƒ ë³€ê²½
            if(item.department === 'fellowship') {
                deptLabel = 'êµìš°ì†Œì‹';
                badgeColor = "bg-purple-100 text-purple-600";
                copyText = `[êµìš°ì†Œì‹] ${item.field1}\n${item.longText}`.trim();
            }
            else if(item.department.includes('ì„¤êµ')) {
                badgeColor = "bg-blue-100 text-blue-600";
                copyText = `[${item.department}]\nì œëª©: ${item.field2}\në³¸ë¬¸: ${item.field1}`;
            } 
            else {
                copyText = `${item.department}\n${item.field1 ? item.field1+' ' : ''}${item.longText}`.trim();
            }

            container.innerHTML += `
                <div class="bg-white p-5 rounded-[20px] shadow-sm mb-4 border border-gray-50">
                    <div class="flex justify-between items-start mb-3">
                        <span class="font-bold text-[#191F28] text-lg">${deptLabel}</span>
                        <span class="text-xs ${badgeColor} px-2 py-1 rounded-md font-bold">${item.writer}</span>
                    </div>
                    <div class="text-[#4E5968] text-sm space-y-2 mb-4">
                        ${item.field1 ? `<p class="font-bold text-[#3182F6] text-base">${item.field1}</p>` : ''}
                        ${item.field2 ? `<p class="font-bold text-black text-lg">${item.field2}</p>` : ''}
                        ${item.longText ? `<p class="whitespace-pre-wrap bg-gray-50 p-3 rounded-xl border border-gray-100 leading-relaxed">${item.longText}</p>` : ''}
                    </div>
                    <button onclick="navigator.clipboard.writeText(\`${copyText.replace(/`/g, '')}\`).then(()=>alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'))" class="w-full py-3 bg-[#F2F4F6] text-[#4E5968] font-bold rounded-xl text-sm hover:bg-[#E5E8EB] transition flex justify-center items-center gap-2">
                        <i class="far fa-copy"></i> ë³µì‚¬í•˜ê¸°
                    </button>
                </div>`;
        });
    }
</script>
</body>
</html>
